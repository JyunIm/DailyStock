<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📈 오늘의 종목</title>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 1.5rem;
    }

    header {
      background-color: transparent;
      color: black;
      padding: 1rem;
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
    }

    .tabs {
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
      border-bottom: 1px solid #ccc;
      background: white;
    }

    .tab {
      padding: 0.75rem 1.2rem;
      cursor: pointer;
      border: none;
      background: none;
      font-weight: bold;
      flex-shrink: 0;
    }

    .tab.active {
      border-bottom: 3px solid #0077cc;
      color: #0077cc;
    }

    .stock-list {
      padding: 1rem;
    }

    .stock-card {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .stock-card h3 {
      margin: 0 0 0.5rem;
    }

    .chart-container {
      margin-top: 1rem;
    }

    .news {
      margin-top: 1rem;
      padding-top: 0.5rem;
      border-top: 1px solid #ccc;
      font-size: 0.95rem;
      color: #333;
    }

    @media (max-width: 600px) {
      .tabs {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>

  <header>📈 오늘의 거래량 상위 종목</header>
  <div class="tabs" id="tabs"></div>
  <div class="stock-list" id="stockList"></div>

  <script>
    const sheetId = "1VoPUB-q7jmz3Z8NPjsCxV8oERLPCSQD3HUCLo0gpf40";
    const gid = "1489164103";
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
    const stockDataByDate = {};

    fetch(url)
      .then(res => res.text())
      .then(rep => {
        const json = JSON.parse(rep.substring(47).slice(0, -2));
        const rows = json.table.rows;

        rows.forEach(row => {
          const cells = row.c;
          if (!cells || cells.length < 5) return;

          const date = cells[0]?.v;
          const code = cells[1]?.v?.toString().padStart(6, "0") || "000000";
          const name = cells[2]?.v || "종목명 없음";
          const volume = cells[3]?.v || "N/A";
          const link = cells[4]?.v || "#";
          const news = cells[5]?.v || "";

          if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) return;

          if (!stockDataByDate[date]) stockDataByDate[date] = [];
          stockDataByDate[date].push({ code, name, volume, link, news });
        });

        renderTabs();
      });

    function renderTabs() {
      const tabs = document.getElementById("tabs");
      tabs.innerHTML = "";

      const dates = Object.keys(stockDataByDate).sort().reverse();

      dates.forEach((date, index) => {
        const tab = document.createElement("button");
        tab.textContent = date;
        tab.className = "tab" + (index === 0 ? " active" : "");
        tab.onclick = () => {
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          renderStockList(date);
        };
        tabs.appendChild(tab);
      });

      if (dates.length > 0) renderStockList(dates[0]);
    }

    function renderStockList(date) {
      const list = document.getElementById("stockList");
      list.innerHTML = "";

      const stocks = stockDataByDate[date] || [];

      stocks.forEach(stock => {
        const card = document.createElement("div");
        card.className = "stock-card";

        const newsHtml = stock.news ? `<div class="news"><strong>📰 관련 뉴스:</strong><br>${stock.news.replace(/\n/g, "<br>")}</div>` : "";

        card.innerHTML = `
          <h3>${stock.name} (${stock.code})</h3>
          <p>📊 거래량: ${Number(stock.volume).toLocaleString()}</p>
          <a class="link" href="${stock.link}" target="_blank">
            <img class="chart-img" src="https://ssl.pstatic.net/imgfinance/chart/mobile/mini/${item.code}.png" alt="${item.name} 차트">
            📈 차트 바로가기</a>
          ${newsHtml}
        `;

        list.appendChild(card);

      });
    }
  </script>

</body>
</html>
